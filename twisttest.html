<!DOCTYPE html>
<html>

<head>
    <title>GLTF Three.js Skeleton Interaction</title>
    <script type="importmap">
        {
            "imports": {
              "three": "./js/three/three.module.js",
              "orbitControls": "./js/three/jsm/OrbitControls.js",
              "transformControls": "./js/penziltransform.js",
              "gltf" : "./js/three/jsm/GLTFLoader.js",
              "vrm" : "./js/three/jsm/three-vrm.module.js",
              "convexGeo": "./js/EWBIK/util/mathdump/ConvexHull.js",
              "enviro" : "./js/environment.js"
            }
          }
    </script>
    <style>
        body {
            margin: 0;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 8px;
            user-select: none;
            pointer-events: none;
        }
        #control-panel {
            z-index: 10; /* Ensure it's above other scene elements */
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: absolute;
        }
        #control-panel button,
        #control-panel label {
            display: inline;
            margin-bottom: 5px;
        }        
    </style>
</head>
<body>
    <script type = "module" src="./js/UIelements.js"></script>
    <script src="js/sceneStuff.js"></script>
    <script type="module">
        const THREE = await import('three');
        import { LayeredRender } from "./js/LayeredRender.js"
        import { TransformControls } from 'transformControls';
        import { OrbitControls } from 'orbitControls';
        import { EWBIK } from "./js/EWBIK/EWBIK.js";
        import { IKNode, TrackingNode } from "./js/EWBIK/util/nodes/IKNodes.js";
        import { Rot } from "./js/EWBIK/util/Rot.js";
        import { IKPin } from "./js/EWBIK/betterbones/IKpin.js";
        import { Rest, Twist, Kusudama } from "./js/EWBIK/betterbones/Constraints/ConstraintStack.js";
        window.Rest = Rest;
        window.OrbitControls = OrbitControls;
        window.TransformControls = TransformControls;
        window.IKNode = IKNode;
        window.TrackingNode = TrackingNode;
        window.IKPin = IKPin;
        window.meshLayer = 0;
        window.boneLayer = 1;
        window.widgetLayer = 2;
        //import { Rest } from "./js/EWBIK/betterbones/Constraints/Rest/Rest.js"

        let camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-0.61, 1.2, -1);
        let renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        window.camera = camera;
        window.renderer = renderer;
        const scene = new THREE.Scene();
        window.scene = scene;
        const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x0000, 3);
        const ambientLight = new THREE.AmbientLight(0x404040);
        window.scene.add(hemisphereLight);
        
        document.body.appendChild(renderer.domElement);
        scene.add(ambientLight);
        window.rendlrs = new LayeredRender(renderer, window.innerWidth, window.innerHeight, 
            (renderer, target) => { //renders mesh stuff
                camera.layers.set(meshLayer);
                renderer.render(scene, camera);
            },
            (renderer, target) => { //renders bones
                camera.layers.set(boneLayer);
                renderer.render(scene, camera);
            },
            (renderer, target) => { //renders bones
                camera.layers.set(widgetLayer);
                renderer.render(scene, camera);
            }
        );      
        
        
        hemisphereLight.layers.enable(boneLayer);
        ambientLight.layers.enable(boneLayer);

        let orbitControls, boneCtrls, pinOrientCtrls, pinTranslateCtrls;

        let selectedBone = null;
        let rootBone = null;

        const axesHelperSize = 24; // Adjust the size as needed
        window.boneAxesHelper = new THREE.AxesHelper(axesHelperSize);
        boneAxesHelper.layers.set(2);

       
        let armature = null;
        let frameCount = 0;
        window.instances = [];
        window.autoSolve = false

        async function init() {
            // Scene
            
            let root = new THREE.Bone();
            root.name = "root";
            let b1 = new THREE.Bone(); 
            b1.position.y = 1;
            b1.name = "b1";
            let b2 = new THREE.Bone(); 
            b2.position.y = 1;
            b2.position.x = 0.5;
            b2.name = "b2"
            root.add(b1);
            b1.add(b2);
            scene.add(root);
            window.armature = new EWBIK(root); 
            window.b1Twist = new Twist(b1);
            window.b2Twist = new Twist(b2);
            window.kusu = new Kusudama(b2);
            kusu.addLimitConeAtIndex(0, new Vec3(0,1,0), 0.5);
            kusu.shell.layers.set(1);
            window.b1Twist.layers.set(1);
            window.b2Twist.layers.set(1);
            addSceneArmature(window.armature);
            /*initEnvironment(scene, renderer, //scene,
                [...getMeshDescendants(window.armature.armatureObj3d.children[1])],
                [0, 1, 2]
            );*/
            initControls(THREE, window.rendlrs);
            animate();
            //const helper = new THREE.SkeletonHelper(rootBone);
            //helper.material.linewidth = 5; // Make the helper lines thicker
            //scene.add(helper);/=
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            render();
        }
        async function animate() {
            requestAnimationFrame(animate);
            render(true);
        }


        window.render = function (incrFrame = false) {
            if (incrFrame) frameCount++;
            //setPinVisibility(frameCount%2 == 0);
            window.fr++;
            doSolve();
            window.rendlrs.render();
        }

        window.addEventListener('resize', onWindowResize, false);
        init();
    </script>
</body>

</html>
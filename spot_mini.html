<!DOCTYPE html>
<html>

<head>
    <title>Three.js Skeleton Interaction</title>
    <script> global = window;</script>
    <script type="importmap">
        {
          "imports": {
            "three": "./js/three/three.module.js",
            "orbitControls": "./js/three/jsm/OrbitControls.js",
            "transformControls": "./js/penziltransform.js",
            "gltf" : "./js/three/jsm/GLTFLoader.js",
            "vrm" : "./js/three/jsm/three-vrm.module.js",
            "convexGeo": "./js/EWBIK/util/mathdump/ConvexHull.js",
            "enviro" : "./js/environment.js",
            "uiElements" : "./js/UIelements.js",
            "sceneStuff" : "./js/sceneStuff.js"
          }
        }
    </script>

</head>


<body>    
    <script type="module">
        import *  as THREE from "three";
        import * as uielems from "uiElements";
        import * as sceneStuff from "sceneStuff";
        import { LayeredRender } from "./js/LayeredRender.js";        
        import { GLTFLoader } from 'gltf';
        import { EWBIK } from "./js/EWBIK/EWBIK.js";
        import { IKSkelHelper } from "./js/EWBIK/helpers/IKSkelHelper.js";         
        import { initSpotMiniRig } from "./js/toys/rigs/spotMini.js";
        import { getMeshDescendants, initEnvironment, setShadowD } from "enviro";
        
        window.pinsOnly = true;
        window.meshLayer = 0;
        window.boneLayer = 1;

        let camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-2,2,3.5);
        window.renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setClearColor(0x000000, 0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        window.camera = camera;
        window.renderer = renderer;
        window.cameraLight = new THREE.DirectionalLight(0xffffff, 1);       
        var scene = new THREE.Scene();
        window.armature = null;
        window.frameCount = 0;
        window.instances = [];

        const loader = new GLTFLoader();

        async function init() {
            window.interactionSolve = false;
            window.showIKBones = false;
            window.showIrrelevantBones = false;
            scene.add(cameraLight);
            cameraLight.position.set(0, 0, 1);
            window.renderableLayers = [true, true, false, true];
            window.scene = scene;
            document.body.appendChild(renderer.domElement);

            await sceneStuff.initControls(renderer);
            let inst1 = await loadModel({ x: 0, y: 0, z: 0 }, 0);
            armature = inst1;
            armature.setDefaultIterations(15);
            armature.setDampening(0.8);
            window.updateParseStream("UI stuff...", 0);
            

            window.armatureHelper = new IKSkelHelper(armature);
            armatureHelper.pinVisibilityCondition = (forPin, forBone) => uielems.contextPinCondition(forPin, forBone);
            armatureHelper.constraintVisibilityCondition = (forConstraint, forBone) => uielems.contextConstraintCondition(forConstraint, forBone); 
            armatureHelper.updateCallback = sceneStuff.updateSceneStuff;
            armatureHelper.init(1,2, -1, 4);
            
            window.updateParseStream(null, 0);

            window.autoSolve = true;
            armature.dirtyRate = true;
            initEnvironment(scene, renderer, //scene,
                [...sceneStuff.getMeshDescendants(armature.armatureObj3d.children[1]),
                ...sceneStuff.getMeshDescendants(armature.rootBone)],
                [0, 1, 2]
            );

            sceneStuff.snapToFocus(armature.bonetags["spot_body_02"], 3);
            sceneStuff.setOrbit(armature.bonetags["spot_body_02"]);
        }

        let lastIK = 0;

        async function loadModel(position, loadId) {
            window.updateLoadStream("Loading model...", loadId);
            let glb = await loader.loadAsync(
                './gltftests/old_spot_mini_rigged.glb',
                (xhr, otherParam) => { window.updateLoadStream(xhr, loadId) },
                (error) => { window.notifyStreamError(error, loadId) }
            );
            let startAt = sceneStuff.findBone(glb.scene).parent;
            scene.add(startAt);            
            
            window.updateParseStream("Building IK Armature...", loadId);
            let armature = new EWBIK(startAt);
            armature.armatureNode.forceOrthonormality = false;
            window.armatures.push(armature);
            window.updateParseStream("Addings constraints...", loadId);
            initSpotMiniRig(armature);
            
            return armature;
        }

        async function animate() {
            requestAnimationFrame(animate);
            cameraLight.position.copy(camera.position);
            render(true);
        }

        init();
        animate();
    </script>
</body>

</html>